{% extends "base.html" %}

{% block title %}Log Stream{% endblock %}

{% block content %}
    <div class="container">
        <h1 class="mt-4">Processing Logs</h1>

        <div id="log-header" class="h5 font-weight-bold mb-3">Latest Log:</div>

        <div id="log-container" class="border p-3" style="max-height: 80vh; background-color: #f9f9f9;"></div>

        <div id="link-container" class="mt-4"></div> <!-- This is where the link will appear -->
    </div>

    <script>
        let isDone = false;  // Flag to check if the process is done
        let fetchLogsInterval;
    
        function fetchLogs() {
            fetch('/get_logs')
                .then(response => response.json())
                .then(logs => {
                    const logContainer = document.getElementById('log-container');
                    const linkContainer = document.getElementById('link-container'); // Ensure this exists

                    if (!logContainer) {
                        console.error("Error: 'log-container' not found.");
                        return;
                    }

                    if (logs.length > 0) {
                        const latestLog = logs[logs.length - 1];
                        logContainer.textContent = latestLog;
                        logContainer.scrollTop = logContainer.scrollHeight;

                        // Check if the latest log indicates completion
                        if (latestLog.startsWith("COMPLETED ")) {
                            const timestamp = latestLog.replace("COMPLETED ", "").trim(); // Extract timestamp

                            // Check if the link already exists to avoid duplicates
                            if (!document.getElementById('completed-link')) {
                                const completedLink = document.createElement('a');
                                completedLink.id = 'completed-link';
                                completedLink.href = `/completed/${timestamp}`;
                                completedLink.textContent = 'View Completed Pattern';
                                completedLink.classList.add('btn', 'btn-primary', 'mt-3');
                                completedLink.style.fontWeight = 'bold';
                                completedLink.style.textDecoration = 'underline';

                                linkContainer.appendChild(completedLink);
                            }

                            logContainer.textContent = "Done!";
                            logContainer.scrollTop = logContainer.scrollHeight;
    
                            // Set the flag to true, indicating the process is complete
                            isDone = true;
    
                            // Stop fetching logs once done
                            clearInterval(fetchLogsInterval);
                        }
                    }
                })
                .catch(error => console.error('Error fetching logs:', error));
        }

        // Fetch logs every 1 second
        fetchLogsInterval = setInterval(fetchLogs, 1000);
    </script>
{% endblock %}
